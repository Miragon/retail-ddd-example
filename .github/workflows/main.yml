name: Build Container & Helm Chart

on:
  push:
  pull_request:
    types: [ opened, reopened ]
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ───────────────────────── PREP ─────────────────────────
      - name: Checkout source
        uses: actions/checkout@v4

      - name: Set up Java 21 (Corretto) + Gradle cache
        uses: actions/setup-java@v4
        with:
          distribution: corretto
          java-version: '21'
          cache: gradle

      # ──────────── BUILD THE JAR ONCE ────────────
      - name: Build JAR with wrapper
        run: ./gradlew --no-daemon clean bootJar

      # ──────── GENERATE A SINGLE BUILD TAG ────────
      - name: Compute semantic version (YYYY.M.D+hash)
        id: vars
        run: |
          DATE=$(date -u '+%Y.%-m.%-d')
          HASH=${GITHUB_SHA::8}
          
          TAG_SEMANTIC="${DATE}+${HASH}"
          TAG="${DATE//./-}-${HASH}"
          
          {
            echo "TAG_SEMANTIC=$TAG_SEMANTIC"
            echo "TAG=$TAG"
          } >> "$GITHUB_OUTPUT"
          
          echo "Helm Version (Semantic) : $TAG_SEMANTIC"
          echo "Docker Tag              : $TAG"

      # ─────────────────── TESTS ───────────────────
      - name: Unit / integration tests
        run: ./gradlew --no-daemon test

      # ──────────────── DOCKER BUILD ───────────────
      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3


      # ──────────────── HELM PACKAGE ───────────────
      - name: Install Helm
        uses: azure/setup-helm@v4

      - name: Package Helm charts with same version
        run: |
          helm lint charts/shop-backend
          helm lint charts/delivery-backend  
          helm lint charts/warehouse-backend
          helm lint charts/shop-frontend
          
          helm package charts/shop-backend \
            --destination charts/ \
            --version "${{ steps.vars.outputs.TAG_SEMANTIC }}" \
            --app-version "${{ steps.vars.outputs.TAG }}"
          
          helm package charts/delivery-backend \
            --destination charts/ \
            --version "${{ steps.vars.outputs.TAG_SEMANTIC }}" \
            --app-version "${{ steps.vars.outputs.TAG }}"
          
          helm package charts/warehouse-backend \
            --destination charts/ \
            --version "${{ steps.vars.outputs.TAG_SEMANTIC }}" \
            --app-version "${{ steps.vars.outputs.TAG }}"
          
          helm package charts/shop-frontend \
            --destination charts/ \
            --version "${{ steps.vars.outputs.TAG_SEMANTIC }}" \
            --app-version "${{ steps.vars.outputs.TAG }}"
          
          echo "All charts packaged successfully"
